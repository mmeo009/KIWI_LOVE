using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;               // UI 추가 
using System;                       // 추가 
using UnityEngine.SceneManagement;                  //유니티 Scene 이동을 위해서 가져옴

public class GameManager : MonoBehaviour
{


    public class Kiwi
    {
        public double MaxFull, MinLevelFull, FullChange = 5;
        public double MaxPlay, MinLevelPlay, PlayChange = 5;
        public double MaxClean, MinLevelClean, CleanChange = 5;
        public float KiwiHP;
        public bool isFull, isPlay, isClean;
        public int KwiwLevel;
        public int generation;
        public float KiwiExp;
        public static double PastMaxF, PastMaxP, PastMaxC;
        public int count;

        //Full=============================================================

        public void GetFull(float amount)
        {
            this.FullChange += amount;
            if (this.FullChange > this.MaxFull)
            {
                this.FullChange = this.MaxFull;
            }
            FullChack();
        }
        public void TakeFull(float amount)
        {
            this.FullChange -= amount;
            if (this.FullChange < 0)
            {
                FullChange = 0;
            }
            FullChack();
            ZeroCount();
        }
        public void FullChack()
        {
            if (this.FullChange >= this.MinLevelFull)
            {
                this.isFull = true;
            }
            else
            {
                this.isFull = false;
            }
        }

        //Play=============================================================

        public void GetPlay(float amount)
        {
            this.PlayChange += amount;
            if (this.PlayChange > this.MaxPlay)
            {
                this.PlayChange = this.MaxPlay;
            }
            PlayChack();
        }
        public void TakePlay(float amount)
        {
            this.PlayChange -= amount;
            if (this.PlayChange < 0)
            {
                PlayChange = 0;
            }
            PlayChack();
            ZeroCount();
        }
        public void PlayChack()
        {
            if (this.PlayChange >= this.MinLevelPlay)
            {
                this.isPlay = true;
            }
            else
            {
                this.isPlay = false;
            }
        }

        //Clean============================================================

        public void GetClean(float amount)
        {
            this.CleanChange += amount;
            if (this.CleanChange > this.MaxClean)
            {
                this.CleanChange = this.MaxClean;
            }
            CleanChack();
        }
        public void TakeClean(float amount)
        {
            this.CleanChange -= amount;
            if (this.CleanChange < 0)
            {
                CleanChange = 0;
            }
            CleanChack();
            ZeroCount();
        }
        public void CleanChack()
        {
            if (this.CleanChange >= this.MinLevelClean)
            {
                this.isClean = true;
            }
            else
            {
                this.isClean = false;
            }
        }
        //HP===============================================================

        public void GetHP(float amount)
        {
            this.KiwiHP += amount;
            if (this.KiwiHP > 30)
            {
                this.KiwiHP = 30;
            }
        }
        public void TakeHP(float amount)
        {
            this.KiwiHP -= amount;
            if (this.KiwiHP < 0)
            {
                KiwiDie();
            }
        }

        //=================================================================

        public void MinLevel()
        {
            this.MinLevelClean = Math.Round(this.MaxClean / 100 * 70);
            this.MinLevelPlay = Math.Round(this.MaxPlay / 100 * 70);
            this.MinLevelFull = Math.Round(this.MaxPlay / 100 * 70);
        }
        public void LevelUp()
        {
            this.MaxClean += 10;
            this.MaxFull += 10;
            this.MaxPlay += 10;
            this.KiwiExp = 0;
        }
        public void ZeroCount()
        {
            if (this.PlayChange == 0 && this.FullChange == 0 && this.CleanChange == 0)
            {
                this.count = 3;
            }
            else if ((this.CleanChange == 0 && this.FullChange == 0) || (this.PlayChange == 0 && this.CleanChange == 0) || (this.FullChange == 0 && this.PlayChange == 0))
            {
                this.count = 2;
            }
            else if (this.PlayChange == 0 || this.FullChange == 0 || this.CleanChange == 0)
            {
                this.count = 1;
            }
            else
            {
                this.count = 0;
            }

        }

        public void NewKiwi()
        {
            if (this.generation == 0)
            {
                this.MaxFull = 10;
                this.MaxPlay = 10;
                this.MaxClean = 10;
                this.FullChange = 5;
                this.PlayChange = 5;
                this.CleanChange = 5;
            }
            else
            {
                this.MaxFull = 10 + Math.Round(PastMaxF / 2);
                this.MaxPlay = 10 + Math.Round(PastMaxP / 2);
                this.MaxClean = 10 + Math.Round(PastMaxC / 2);
                this.FullChange = Math.Round(MaxFull / 2);
                this.PlayChange = Math.Round(MaxPlay / 2);
                this.CleanChange = Math.Round(MaxClean / 2);
            }
            this.KiwiHP = 30;
            this.KiwiExp = 0;
            this.generation++;
            MinLevel();
            ZeroCount();
        }
        public void KiwiDie()
        {
            PastMaxC = this.MaxClean;
            PastMaxF = this.MaxFull;
            PastMaxP = this.MaxPlay;
            NewKiwi(); // 테스트용 나중에 삭제
        }
    }
    public enum GameState           //게임 상태값 설정
    {
        Start,
        Playing,
        Battle
    }

    public event Action<GameState> OnGameStateChanged;

    public GameState currentState = GameState.Start;

    //=================================================================
    // 변수 선언 
    //=================================================================


    public Kiwi kiwi;
    public int Coin;
    public GameState CurrentState
    {
        get { return currentState; }
        private set
        {
            currentState = value;
            OnGameStateChanged?.Invoke(currentState);       //이벤트가 null이 아닌경우에만 이 이벤트를 호출 
        }
    }
    public GameManager() { }
    public static GameManager Instance { get; private set; }    //싱글톤화

    private void Awake()
    {
        if (Instance)
        {
            Destroy(gameObject);
            return;
        }
        else
        {
            transform.parent = null;
            Instance = this;
            DontDestroyOnLoad(gameObject);
        }
        SceneManager.sceneLoaded += OnSceneLoaded;

    }
    public void Start()
    {   //게임 시작 로직을 여기에 작성
        kiwi = new Kiwi();
        kiwi.NewKiwi();
    }

    private void OnDestroy()    //이 오브젝트가 파괴될 경우
    {
        SceneManager.sceneLoaded -= OnSceneLoaded;  //이벤트를 삭제한다. 
    }
    private void OnSceneLoaded(Scene scene, LoadSceneMode mode)
    {

    }
    public void MoveScene(string SceneName)
    {
        SceneManager.LoadScene(SceneName);
    }

    public void UseCoin(int amount)
    {
        Coin -= amount;
    }
    public void GetCoin(int amount)
    {
        Coin += amount;
    }
}
